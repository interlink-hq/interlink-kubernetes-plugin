apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "bastion.fullname" . }}-{{ .Values.tunnel.gateway.host }}-{{ .Values.tunnel.service.gatewayPort }}
  labels:
    {{- include "bastion.labels" . | nindent 4 }}
    interlink/role: {{ include "bastion.name" . }}
spec:
  replicas: 1
  selector:
    matchLabels:
      {{- include "bastion.selectorLabels" . | nindent 6 }}
      interlink/role: {{ include "bastion.name" . }}
  template:
    metadata:
      labels:
        {{- include "bastion.labels" . | nindent 8 }}
        interlink/role: {{ include "bastion.name" . }}
    spec:
      containers:
        - name: openssh-client
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          command: ["/bin/sh", "-c"]
          args:
          - >-
            eval "$(ssh-agent -s)" &&
            echo "$SSH_DEPLOY_KEY" | ssh-add - &&
            ssh -N -R 0.0.0.0:${GATEWAY_TUNNEL_PORT}:${SERVICE_HOST}:${SERVICE_PORT} ${GATEWAY_USER}@${GATEWAY_HOST} -p ${GATEWAY_PORT}
            # - ssh -N -R 0.0.0.0:8181:mlaas-inference-service-predictor-00001.mlaas.svc.cluster.local:80 interlink-user@131.154.98.72 -p 30222
          resources:
            {{- toYaml .Values.resources | nindent 12 }}
          env:
            - name: SSH_DEPLOY_KEY
              valueFrom:
                secretKeyRef:
                  name: {{ include "bastion.fullname" . }}-{{ .Values.tunnel.gateway.host }}-{{ .Values.tunnel.service.gatewayPort }}
                  key: SSH_PRIVATE_KEY
          envFrom:
            - configMapRef:
                name: {{ include "bastion.fullname" . }}-{{ .Values.tunnel.gateway.host }}-{{ .Values.tunnel.service.gatewayPort }}
